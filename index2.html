<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DASHBOARD FISCAL√çA GENERAL DE LA NACI√ìN SECCIONAL MEDELL√çN</title>
    
    <!-- Librer√≠as externas -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@8.2.2/build/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    
    <link rel="stylesheet" href="styles.css">
    <style>
        .test-button {
            background: linear-gradient(45deg, #00ff41, #00ff88);
            color: #000;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            margin: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0,255,65,0.3);
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,255,65,0.5);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="main-header">
        <div class="header-content">
            <div class="logo-section">
                <i class="fas fa-shield-alt"></i>
                <div>
                    <h1 class="main-title">DASHBOARD FISCAL√çA GENERAL DE LA NACI√ìN</h1>
                    <p class="subtitle">SECCIONAL MEDELL√çN - AN√ÅLISIS INTELIGENTE DE DATOS</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Container Principal -->
    <div class="dashboard-container">
        
        <!-- Panel de Control -->
        <section class="control-panel">
            <h2><i class="fas fa-upload"></i> CARGA DE DATOS</h2>
            
            <div class="upload-section">
                <div class="file-input-container">
                    <input type="file" id="csvFileInput" accept=".csv" multiple>
                    <label for="csvFileInput" class="file-input-label">
                        <i class="fas fa-file-csv"></i>
                        <span>Seleccionar archivos CSV</span>
                    </label>
                    
                    <!-- Botones de prueba -->
                    <button id="testLoadBtn" class="test-button">
                        üß™ CARGAR DATOS DE PRUEBA
                    </button>
                </div>
                
                <div id="fileList"></div>
                
                <button id="processBtn" class="action-btn" disabled>
                    <i class="fas fa-brain"></i>
                    Procesar con IA
                </button>
            </div>
        </section>

        <!-- Panel de Estad√≠sticas -->
        <section class="stats-panel">
            <h2><i class="fas fa-chart-bar"></i> ESTAD√çSTICAS</h2>
            <div class="stats-grid" id="statsContainer">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-database"></i></div>
                    <div class="stat-content">
                        <h3 id="totalRecords">0</h3>
                        <p>Registros Totales</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="stat-content">
                        <h3 id="totalCrimes">0</h3>
                        <p>Tipos de Delitos</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-map-marker-alt"></i></div>
                    <div class="stat-content">
                        <h3 id="totalCities">0</h3>
                        <p>Ciudades</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-calendar-alt"></i></div>
                    <div class="stat-content">
                        <h3 id="dateRange">-</h3>
                        <p>Per√≠odo Analizado</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Panel de Gr√°ficos -->
        <section class="charts-panel">
            <h2><i class="fas fa-chart-line"></i> VISUALIZACI√ìN DE DATOS</h2>
            <div class="charts-grid">
                <div class="chart-container">
                    <h3>Delitos por Ciudad</h3>
                    <canvas id="cityChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>Tendencia Temporal</h3>
                    <canvas id="timeChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>Tipos de Delitos</h3>
                    <canvas id="crimeTypeChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>Distribuci√≥n Mensual</h3>
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Panel de IA Insights -->
        <section class="insights-panel">
            <h2><i class="fas fa-lightbulb"></i> AN√ÅLISIS DE INTELIGENCIA ARTIFICIAL</h2>
            <div id="aiInsights" class="insights-content">
                <div class="insight-placeholder">
                    <i class="fas fa-robot"></i>
                    <p>Los insights de IA aparecer√°n aqu√≠ despu√©s de procesar los datos...</p>
                </div>
            </div>
            
            <button id="generateReportBtn" class="action-btn secondary" style="display: none;">
                <i class="fas fa-file-alt"></i>
                Generar Informe Completo
            </button>
        </section>
    </div>

    <!-- Script simplificado -->
    <script>
        let csvData = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Dashboard iniciado');
            console.log('Papa Parse disponible:', typeof Papa !== 'undefined');
            console.log('Chart.js disponible:', typeof Chart !== 'undefined');
            
            const fileInput = document.getElementById('csvFileInput');
            const testLoadBtn = document.getElementById('testLoadBtn');
            const processBtn = document.getElementById('processBtn');
            
            // Event listener para archivo manual
            fileInput.addEventListener('change', function(e) {
                console.log('üìÅ Archivo seleccionado');
                handleFileSelection(e.target.files);
            });
            
            // Event listener para datos de prueba
            testLoadBtn.addEventListener('click', function() {
                console.log('üß™ Cargando datos de prueba');
                loadTestData();
            });
            
            // Event listener para procesar datos
            processBtn.addEventListener('click', function() {
                console.log('üî¨ Procesando datos con IA');
                processDataWithAI();
            });
        });
        
        function handleFileSelection(files) {
            if (!files || files.length === 0) return;
            
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '<div style="color: #00ff41;">‚è≥ Procesando archivo...</div>';
            
            const file = files[0]; // Tomar el primer archivo
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const csvText = e.target.result;
                console.log('üìÑ Archivo le√≠do:', csvText.length, 'caracteres');
                
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        console.log('‚úÖ CSV parseado:', results.data.length, 'filas');
                        csvData = results.data;
                        
                        fileList.innerHTML = `
                            <div style="color: #00ff41; background: rgba(0,255,65,0.1); padding: 1rem; border-radius: 8px; border: 1px solid #00ff41;">
                                <h4>‚úÖ Archivo Cargado: ${file.name}</h4>
                                <p>üìä ${results.data.length} registros</p>
                                <p>üìã Columnas: ${Object.keys(results.data[0] || {}).join(', ')}</p>
                            </div>
                        `;
                        
                        document.getElementById('processBtn').disabled = false;
                        updateStats();
                    }
                });
            };
            
            reader.readAsText(file);
        }
        
        function loadTestData() {
            const sampleData = \`delito,ciudad,fecha,cantidad,departamento
Hurto a personas,Medell√≠n,2024-01-15,25,Antioquia
Homicidio,Bello,2024-01-15,3,Antioquia
Extorsi√≥n,Itag√º√≠,2024-01-15,8,Antioquia
Hurto a residencias,Envigado,2024-01-15,12,Antioquia
Lesiones personales,Sabaneta,2024-01-15,15,Antioquia
Hurto a personas,Medell√≠n,2024-02-15,28,Antioquia
Homicidio,Bello,2024-02-15,4,Antioquia
Extorsi√≥n,Itag√º√≠,2024-02-15,12,Antioquia
Hurto a residencias,Envigado,2024-02-15,10,Antioquia
Lesiones personales,Sabaneta,2024-02-15,18,Antioquia
Violencia intrafamiliar,Medell√≠n,2024-02-15,22,Antioquia
Hurto a comercio,Bello,2024-02-15,9,Antioquia
Hurto a personas,Medell√≠n,2024-03-15,35,Antioquia
Homicidio,Bello,2024-03-15,2,Antioquia
Extorsi√≥n,Itag√º√≠,2024-03-15,15,Antioquia
Hurto a residencias,Envigado,2024-03-15,14,Antioquia
Lesiones personales,Sabaneta,2024-03-15,20,Antioquia
Violencia intrafamiliar,Medell√≠n,2024-03-15,25,Antioquia
Hurto a comercio,Bello,2024-03-15,11,Antioquia
Estafa,Medell√≠n,2024-03-15,18,Antioquia\`;
            
            Papa.parse(sampleData, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    console.log('‚úÖ Datos de prueba cargados:', results.data.length, 'filas');
                    csvData = results.data;
                    
                    document.getElementById('fileList').innerHTML = \`
                        <div style="color: #00ff41; background: rgba(0,255,65,0.1); padding: 1.5rem; border-radius: 10px; border: 2px solid #00ff41;">
                            <h3>‚úÖ DATOS DE PRUEBA CARGADOS</h3>
                            <p>üìä \${results.data.length} registros de ejemplo</p>
                            <p>üèôÔ∏è Ciudades: Medell√≠n, Bello, Itag√º√≠, Envigado, Sabaneta</p>
                            <p>üö® Tipos de delitos: \${[...new Set(results.data.map(r => r.delito))].length}</p>
                        </div>
                    \`;
                    
                    document.getElementById('processBtn').disabled = false;
                    updateStats();
                }
            });
        }
        
        function updateStats() {
            if (csvData.length === 0) return;
            
            document.getElementById('totalRecords').textContent = csvData.length;
            document.getElementById('totalCrimes').textContent = [...new Set(csvData.map(r => r.delito))].length;
            document.getElementById('totalCities').textContent = [...new Set(csvData.map(r => r.ciudad))].length;
            
            const dates = csvData.map(r => r.fecha).filter(d => d);
            if (dates.length > 0) {
                const minDate = new Date(Math.min(...dates.map(d => new Date(d))));
                const maxDate = new Date(Math.max(...dates.map(d => new Date(d))));
                document.getElementById('dateRange').textContent = \`\${minDate.getFullYear()} - \${maxDate.getFullYear()}\`;
            }
        }
        
        function processDataWithAI() {
            console.log('ü§ñ Iniciando an√°lisis con IA...');
            
            const insights = document.getElementById('aiInsights');
            insights.innerHTML = \`
                <div style="color: #00ff41; background: rgba(0,255,65,0.1); padding: 1.5rem; border-radius: 10px; border: 1px solid #00ff41;">
                    <h3>ü§ñ AN√ÅLISIS DE IA COMPLETADO</h3>
                    <div style="margin: 1rem 0;">
                        <h4>üìä Estad√≠sticas Principales:</h4>
                        <ul>
                            <li>Total de registros analizados: \${csvData.length}</li>
                            <li>Tipos de delitos identificados: \${[...new Set(csvData.map(r => r.delito))].length}</li>
                            <li>Ciudades en an√°lisis: \${[...new Set(csvData.map(r => r.ciudad))].join(', ')}</li>
                        </ul>
                    </div>
                    
                    <div style="margin: 1rem 0;">
                        <h4>üéØ Insights Principales:</h4>
                        <ul>
                            <li>El delito m√°s frecuente es: \${getMostFrequentCrime()}</li>
                            <li>La ciudad con m√°s incidentes es: \${getMostAffectedCity()}</li>
                            <li>Tendencia temporal: \${getTemporalTrend()}</li>
                        </ul>
                    </div>
                </div>
            \`;
            
            document.getElementById('generateReportBtn').style.display = 'block';
            createCharts();
        }
        
        function getMostFrequentCrime() {
            const crimes = {};
            csvData.forEach(row => {
                crimes[row.delito] = (crimes[row.delito] || 0) + 1;
            });
            return Object.keys(crimes).reduce((a, b) => crimes[a] > crimes[b] ? a : b);
        }
        
        function getMostAffectedCity() {
            const cities = {};
            csvData.forEach(row => {
                cities[row.ciudad] = (cities[row.ciudad] || 0) + (parseInt(row.cantidad) || 1);
            });
            return Object.keys(cities).reduce((a, b) => cities[a] > cities[b] ? a : b);
        }
        
        function getTemporalTrend() {
            return 'An√°lisis temporal indica variaciones estacionales en los patrones delictivos';
        }
        
        function createCharts() {
            console.log('üìà Creando gr√°ficos...');
            // Aqu√≠ ir√≠a la l√≥gica de gr√°ficos con Chart.js
            // Por simplicidad, solo muestro que se ejecuta
        }
    </script>
</body>
</html>